version: 2.1
orbs:
  node: circleci/node@2.1.1
  docker: circleci/docker@1.0.1

setup_license_scanner: &setup_license_scanner
  name: Install and set up license-scanner
  command: |
    git clone https://github.com/mojaloop/license-scanner /tmp/license-scanner
    cd /tmp/license-scanner && make build default-files set-up

jobs:
  setup:
    executor: node/default
    steps:
      - checkout    
      - node/install-packages
      - save_cache:
          key: dependency-cache-{{ checksum "package-lock.json" }}
          paths:
            - node_modules
  test-unit:
    executor: node/default
    steps:
      - checkout    
      - restore_cache:
          keys:
            - dependency-cache-{{ checksum "package-lock.json" }}
      - run: mkdir -p ./test/results
      - run: npm run test:unit
      - run: mv ./junit.xml ./test/results/unit-junit.xml
      - store_artifacts:
          path: ./test/results
          prefix: test
      - store_test_results:
          path: ./test/results

  test-bdd:
    executor: node/default
    steps:
      - checkout    
      - restore_cache:
          keys:
            - dependency-cache-{{ checksum "package-lock.json" }}
      - run: mkdir -p ./test/results
      - run: npm run test:bdd
      - run: mv ./junit.xml ./test/results/bdd-junit.xml
      - store_artifacts:
          path: ./test/results
          prefix: test
      - store_test_results:
          path: ./test/results
  
  check-vulnerabilities:
    executor: node/default
    steps:
      - checkout
      - restore_cache:
          keys:
            - dependency-cache-{{ checksum "package-lock.json" }}
      - run:
          name: Create dir for audit results
          command: mkdir -p ./audit/results
      - run:
          name: Check for new npm vulnerabilities
          command: npm run audit:check --silent -- --json > ./audit/results/auditResults.json
      - store_artifacts:
          path: ./audit/results
          prefix: audit 

  audit-licencees:
    executor: node/default
    steps:
      - checkout
      - run: *setup_license_scanner
      - restore_cache:
          key: dependency-cache-{{ checksum "package-lock.json" }}
      - run:
          name: Prune non-production packages before running license-scanner
          command: npm prune --production
      - run:
          name: Run the license-scanner
          command: cd /tmp/license-scanner && pathToRepo=/home/circleci/project make run
      - store_artifacts:
          path: /tmp/license-scanner/results
          prefix: licenses

workflows:
  version: 2
  build_accept:
    jobs:
      - setup
      - test-unit:
          requires:
            - setup
      - test-bdd:
          requires:
            - setup
      - check-vulnerabilities:
          requires:
            - setup
      - audit-licencees:
          requires:
            - setup